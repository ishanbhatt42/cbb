---
title: "Economic Analysis"
author: "Ishan Bhatt"
date: "11/1/2020"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(tidyverse)
library(janitor)

earnings = read_csv("raw-data/employee_earnings_11_1.csv") %>%
  clean_names()
field_contact = read_csv("raw-data/field_contact_rms_10_28.csv") %>%
  clean_names()
property_values = read_csv("raw-data/property_values_11_1.csv") %>%
  clean_names()

property_values$zipcode <- paste0("0", property_values$zipcode)
property_values$zipcode <- property_values$zipcode %>% str_remove(pattern = "-0000")
field_contact$zip <- field_contact$zip %>% str_remove(pattern = "-0000")

```

```{r scraping}

# Boston population data scraping.

library(rvest)

scrape_boston <- function(link) {
  
  x <- read_html(link) %>%
    html_nodes("table")
  
  x[[13]] %>%
    html_table(fill = TRUE) %>%
   row_to_names(1) %>%
   clean_names() %>%
   select(-number, -city, -national_rank)
  
}

pop_1 <- scrape_boston("http://zipatlas.com/us/ma/zip-code-comparison/population-density.htm")
pop_2 <- scrape_boston("http://zipatlas.com/us/ma/zip-code-comparison/population-density.2.htm")
pop_3 <- scrape_boston("http://zipatlas.com/us/ma/zip-code-comparison/population-density.3.htm")
pop_4 <- scrape_boston("http://zipatlas.com/us/ma/zip-code-comparison/population-density.4.htm")
pop_5 <- scrape_boston("http://zipatlas.com/us/ma/zip-code-comparison/population-density.5.htm")


pop <- pop_1 %>%
  rbind(pop_2) %>%
  rbind(pop_3) %>%
  rbind(pop_4) %>%
  rbind(pop_5) %>%
  as.data.frame()

pop$population <- as.numeric(gsub(",","",pop$population))
pop$people_sq_mile<- as.numeric(gsub(",","",pop$people_sq_mile))

rownames(pop) <- 1:nrow(pop)

```

```{r tidying}
# Field contact data modification.

field_tidy <- field_contact %>%
  group_by(zip, basis) %>%
  summarize(count = n(), .groups = "drop") 

field_tidy$count <- as.numeric(field_tidy$count)
  
field_tidy <- field_tidy %>%
  group_by(zip) %>%
  mutate(total = sum(count)) %>%
  ungroup() %>%
  pivot_wider(id_cols = c("zip", "total"), names_from = basis, values_from = count) %>%
  clean_names()

# Property data.

property_tidy <- property_values %>%
  rename("zip" = "zipcode") %>%
  group_by(zip) %>%
  summarize(median_tax = median(gross_tax), .groups = "drop")

grouped <- field_tidy %>%
  left_join(property_tidy, by = c("zip")) %>%
  filter(zip != "00000")

grouped <- grouped %>%
  left_join(pop, by = c("zip" = "zip_code")) %>%
  mutate(total_by_pop = ((total * 100) / population))

```


```{r csv outputs}

write.csv(pop, file = "outputs/population_zip_ma.csv")

write.csv(grouped, file = "outputs/property_encounters.csv")

```


```{r experimental graphics}



```





